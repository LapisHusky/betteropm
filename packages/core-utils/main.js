(function() {
    let exports = {}
    let _0x116e0b = exports
    
    var _0x1a5ab4 = function() {
        var _0x34b517 = true;
        return function(_0x1a51ab, _0x26d39b) {
            var _0x3a8e2d = _0x34b517 ? function() {
                if (_0x26d39b) {
                    var _0x447b7e = _0x26d39b.apply(_0x1a51ab, arguments);

                    _0x26d39b = null;
                    return _0x447b7e;
                }
            } : function() {};

            _0x34b517 = false;
            return _0x3a8e2d;
        };
    }();

    var _0x323948 = _0x1a5ab4(this, function() {
        var _0x89e029 = function() {
                return 'dev';
            },
            _0x51ebd1 = function() {
                return 'window';
            };

        var _0x1e4d8d = function() {
            var _0x242f82 = new RegExp('\\w+ *\\(\\) *{\\w+ *[\'|"].+[\'|"];? *}');

            return !_0x242f82.test(_0x89e029.toString());
        };

        var _0x2d4f4c = function() {
            var _0x9d0d99 = new RegExp('(\\\\[x|u](\\w){2,4})+');

            return _0x9d0d99.test(_0x51ebd1.toString());
        };

        var _0x30df37 = function(_0x1f64d9) {
            if (_0x1f64d9.indexOf('i' === 0)) {
                _0x3670ee(_0x1f64d9);
            }
        };

        var _0x3670ee = function(_0x41b78d) {
            if (_0x41b78d.indexOf('e') !== 3) {
                _0x30df37(_0x41b78d);
            }
        };

        if (!_0x1e4d8d()) {
            if (!_0x2d4f4c()) {
                _0x30df37('indеxOf');
            } else {
                _0x30df37('indexOf');
            }
        } else {
            _0x30df37('indеxOf');
        }
    });

    _0x323948();

    var _0x152e6c = function() {
        var _0x17021a = {
            'qyRIs': function(_0x114953, _0x23c83a) {
                return _0x114953 + _0x23c83a;
            },
            'rvaDe': function(_0x4c3f0e, _0x35d2d3) {
                return _0x4c3f0e === _0x35d2d3;
            },
            'uJEZv': function(_0x229264, _0x29efe9) {
                return _0x229264 !== _0x29efe9;
            },
            'OQFEF': function(_0x1f4c45, _0x1491f8) {
                return _0x1f4c45 !== _0x1491f8;
            },
            'zXSdv': function(_0x41b4c2, _0x5eaba9) {
                return _0x41b4c2 === _0x5eaba9;
            },
            'oGmvk': 'Local commands: ',
            'uDNTP': 'nKBNh',
            'YAHCr': 'nXHHp',
            'VdAAU': 'Auther',
            'lmyHb': 'ihhjW',
            'qhWfV': 'oSvYF'
        }; {
            var _0x395dd0 = true;
            return function(_0x2db208, _0x323bac) {
                var _0x39dbda = {
                    'eBczY': function(_0x1d7a34, _0x309f40) {
                        return _0x1d7a34 !== _0x309f40;
                    },
                    'IbiAA': 'Auther'
                }; {
                    var _0xa22816 = _0x395dd0 ? function() {
                        var _0x5579f9 = {
                            'TNwiq': function(_0x1be857, _0x2cbc84) {
                                return _0x1be857 === _0x2cbc84;
                            }
                        }; {
                            if (_0x323bac) {
                                var _0x2146d2 = _0x323bac.apply(_0x2db208, arguments);

                                _0x323bac = null;
                                return _0x2146d2;
                            }
                        }
                    } : function() {};

                    _0x395dd0 = false;
                    return _0xa22816;
                }
            };
        }
    }();

    var _0x2cd280 = _0x152e6c(this, function() {
        var _0x397bca = {
            'TTOKp': function(_0x15ee69, _0xe5259c) {
                return _0x15ee69 === _0xe5259c;
            },
            'eeDbF': function(_0x3d4d3f, _0x1dd352, _0x517477) {
                return _0x3d4d3f(_0x1dd352, _0x517477);
            },
            'xNIgf': function(_0x3a9e45, _0x1be17a) {
                return _0x3a9e45 === _0x1be17a;
            },
            'ItCHj': function(_0x7848b0, _0x230a77) {
                return _0x7848b0 < _0x230a77;
            },
            'ubISl': function(_0x1b1d51, _0x3c30c9) {
                return _0x1b1d51 === _0x3c30c9;
            },
            'sSNvi': function(_0x5ab651, _0x195183) {
                return _0x5ab651 > _0x195183;
            },
            'AmKyP': function(_0x4caf46, _0x1cc712) {
                return _0x4caf46 + _0x1cc712;
            },
            'tRXtU': function(_0x98301f, _0xb52db0) {
                return _0x98301f + _0xb52db0;
            },
            'bgzjO': function(_0x5b5abb, _0x4774e0) {
                return _0x5b5abb + _0x4774e0;
            },
            'PZlUi': function(_0x268fff, _0x85bde5) {
                return _0x268fff + _0x85bde5;
            },
            'Cttbd': function(_0x2b399c, _0x22c925) {
                return _0x2b399c + _0x22c925;
            },
            'DtHsR': function(_0x36c89e, _0x2cfada) {
                return _0x36c89e < _0x2cfada;
            },
            'daedK': function(_0x154f7b, _0x24e137) {
                return _0x154f7b > _0x24e137;
            },
            'pjLPP': function(_0x44fd12, _0x54d223) {
                return _0x44fd12 + _0x54d223;
            },
            'nXXqk': function(_0x2f928b, _0x4357f4) {
                return _0x2f928b + _0x4357f4;
            },
            'HXBRV': function(_0x1220a7, _0x81c8c2) {
                return _0x1220a7 + _0x81c8c2;
            },
            'zAGhf': function(_0x3a0cc0, _0x3ee01c) {
                return _0x3a0cc0 + _0x3ee01c;
            },
            'VvdXJ': function(_0x27a913, _0x5c1709) {
                return _0x27a913 + _0x5c1709;
            },
            'PbqNa': function(_0x243681, _0x359fe6) {
                return _0x243681 in _0x359fe6;
            },
            'zkNDB': function(_0x159e70, _0x27aaed) {
                return _0x159e70 === _0x27aaed;
            },
            'eGCkc': function(_0x5eafc5, _0x14ea18) {
                return _0x5eafc5 == _0x14ea18;
            },
            'DFltE': function(_0x1232a6, _0x184c86) {
                return _0x1232a6 === _0x184c86;
            },
            'qEhvA': 'https://ourworldofpixels.com/api/playerinfo',
            'YSIQh': 'user',
            'nQJBu': 'AQEZo',
            'XBORy': 'yypDd',
            'cofuk': 'leave',
            'omljV': '2|3|6|4|1|0|5'
        }; {
            var _0x33a6c9 = function() {
                var _0x1bd055;

                try {
                    _0x1bd055 = function() {
                        return function() {}.constructor("return this")();
                    }();
                } catch (_0x2b11f0) {
                    _0x1bd055 = window;
                }

                return _0x1bd055;
            };

            var _0x38467f = _0x33a6c9();

            var _0x4dad4f = function() {
                return {
                    'key': 'item',
                    'value': 'attribute',
                    'getAttribute': function() {
                        var _0x5e653e = {
                            'xmeGf': 'user'
                        }; {
                            for (var _0x51955a = 0; _0x51955a < 1000; _0x51955a--) {
                                var _0x30e168 = _0x51955a > 0;

                                switch (_0x30e168) {
                                    case true:
                                        return this.item + '_' + this.value + '_' + _0x51955a;

                                    default:
                                        this.item + '_' + this.value;
                                }
                            }
                        }
                    }()
                };
            };

            var _0x2ee71f = '/[nJOtFObPaWnkhZbLSvtKQHDAynNWWEyMZzLSQY]g';

            var _0xe678f0 = ['ourworldofpixels.com'];

            var _0x59a16e;

            var _0x3fe0e1;

            var _0x10a35c;

            var _0x3c3761;

            for (var _0x2ea028 in _0x38467f) {
                if (_0x2ea028.length == 8 && _0x2ea028.charCodeAt(7) == 116 && _0x2ea028.charCodeAt(5) == 101 && _0x2ea028.charCodeAt(3) == 117 && _0x2ea028.charCodeAt(0) == 100) {
                    _0x59a16e = _0x2ea028;
                    break;
                }
            }

            for (var _0xb36f1c in _0x38467f[_0x59a16e]) {
                if (_0xb36f1c.length == 6 && _0xb36f1c.charCodeAt(5) == 110 && _0xb36f1c.charCodeAt(0) == 100) {
                    _0x3fe0e1 = _0xb36f1c;
                    break;
                }
            }

            if (!('~' > _0x3fe0e1)) {
                for (var _0x3c144d in _0x38467f[_0x59a16e]) {
                    if (_0x3c144d.length == 8 && _0x3c144d.charCodeAt(7) == 110 && _0x3c144d.charCodeAt(0) == 108) {
                        _0x10a35c = _0x3c144d;
                        break;
                    }
                }

                for (var _0x4ad021 in _0x38467f[_0x59a16e][_0x10a35c]) {
                    if (_0x4ad021.length == 8 && _0x4ad021.charCodeAt(7) == 101 && _0x4ad021.charCodeAt(0) == 104) {
                        _0x3c3761 = _0x4ad021;
                        break;
                    }
                }
            }

            if (!_0x59a16e || !_0x38467f[_0x59a16e]) {
                return;
            }

            var _0x1f7e53 = _0x38467f[_0x59a16e][_0x3fe0e1];

            var _0x1c2322 = !!_0x38467f[_0x59a16e][_0x10a35c] && _0x38467f[_0x59a16e][_0x10a35c][_0x3c3761];

            var _0x2dd8d2 = _0x1f7e53 || _0x1c2322;

            if (!_0x2dd8d2) {
                return;
            }

            var _0x30f9a2 = false;

            for (var _0x35f621 = 0; _0x35f621 < _0xe678f0.length; _0x35f621++) {
                var _0x3fe0e1 = _0xe678f0[_0x35f621];

                var _0x23d87 = _0x2dd8d2.length - _0x3fe0e1.length;

                var _0x5dfe43 = _0x2dd8d2.indexOf(_0x3fe0e1, _0x23d87);

                var _0x10332c = _0x5dfe43 !== -1 && _0x5dfe43 === _0x23d87;

                if (_0x10332c) {
                    if (_0x2dd8d2.length == _0x3fe0e1.length || _0x3fe0e1.indexOf('.') === 0) {
                        _0x30f9a2 = true;
                    }
                }
            }

            if (!_0x30f9a2) {
                data;
            } else {
                return;
            }

            _0x4dad4f();
        }
    });

    _0x2cd280();

    /*if (Date.now() - _0x44bf1f > 60000) {
        return;
    }*/

    /*setInterval(function() {
        if (_0x2e620a.constructor.name !== 'Auther') {}
    }, 10000);*/
    console.log('loading core-utils');

    const OWOP_Events = OWOP.require('events');

    class Player {
        constructor(id, x, y, rgb, tool) {
            var props = ["4", "6", "3", "2", "1", "5", "0"],
                currentProp = '0';

            while ('true') {
                switch (QmWyvk[currentProp++]) {
                    case '0':
                        this.o = {};
                        continue;

                    case '1':
                        this.tool = tool;
                        continue;

                    case '2':
                        this.rgb = rgb;
                        continue;

                    case '3':
                        this.y = y;
                        continue;

                    case '4':
                        this.id = id;
                        continue;

                    case '5':
                        this.nick = null;
                        continue;

                    case '6':
                        this.x = x;
                        continue;
                }

                break;
            }
        }

    }


    class Players extends Events {
        constructor() {
            super();
            this.list = {};
            let oldPlayers = OWOP.misc.world.players;

            for (let id in oldPlayers) {
                let p = oldPlayers[id];
                this.list[id] = new Player(id, p.x, p.y, p.rgb, p.tool.id);
                let player = this.list[id];

                if (OWOP.player.rank === 2 && OWOP.world.name === 'main') {
                    fetch('https://ourworldofpixels.com/api/playerinfo', {
                        headers: {
                            'x-player-id': id,
                            'x-password': JSON.parse(localStorage.worldPasswords).main
                        }
                    }).then(i => i.json()).then(i => {
                        if (i.data) {
                            fetch('https://ourworldofpixels.com/api/playerinfo', {
                                headers: {
                                    'x-player-ip': i.data,
                                    'x-password': JSON.parse(localStorage.worldPasswords).main
                                }
                            }).then(i => i.json()).then(i => {
                                if (i.data.connInfo[0]) {
                                    player.o = i.data.connInfo[0];
                                    if (player.o.nick.includes(']')) player.nick = player.o.nick.split('] ').slice(1).join(']');
                                    if (player.o.rank === 3) player.nick = player.o.nick;
                                    player.rank = player.o.rank;
                                }
                            });
                        }
                    });
                }
            }

            OWOP.on(OWOP.events.net.world.playersMoved, players => {
                for (let id in players) {
                    if (!(id in this.list)) {
                        this.playerJoin(id, players[id]);
                    } else {
                        this.list[id].x = players[id].x;
                        this.list[id].y = players[id].y;
                        this.list[id].rgb = players[id].rgb;
                        this.list[id].tool = players[id].tool;
                    }
                }
            });
            OWOP.on(OWOP.events.net.world.playersLeft, players => {
                for (let i = 0; i < players.length; i++) {
                    this.playerLeave(players[i]);
                }
            });
        }

        playerJoin(id, data) {
            let player = new Player(id, data.x, data.y, data.rgb, data.tool);

            if (OWOP.player.rank === 2 && OWOP.world.name === 'main') {
                fetch('https://ourworldofpixels.com/api/playerinfo', {
                    headers: {
                        'x-player-id': id,
                        'x-password': JSON.parse(localStorage.worldPasswords).main
                    }
                }).then(i => i.json()).then(i => {
                    if (i.data) {
                        fetch('https://ourworldofpixels.com/api/playerinfo', {
                            headers: {
                                'x-player-ip': i.data,
                                'x-password': JSON.parse(localStorage.worldPasswords).main
                            }
                        }).then(i => i.json()).then(i => {
                            if (i.data.connInfo[0]) {
                                player.o = i.data.connInfo[0];
                                if (player.o.nick.includes(']')) player.nick = player.o.nick.split('] ').slice(1).join(']');
                                if (player.o.rank === 3) player.nick = player.o.nick;
                                player.rank = player.o.rank;
                            }
                        });
                    }
                });
            }

            this.list[id] = player;
            this.emit('join', player);
        }

        playerLeave(id) {
            let player = this.list[id];
            delete this.list[id];
            this.emit('leave', player);
        }

    }

    let players = new Players();


    class Chat extends Events {
        constructor() {
            super();
            this.commands = {};
            OWOP.on(OWOP.events.net.chat, msg => {
                let obj;

                if (msg.startsWith('[D] ')) {
                    let nick = msg.split(': ')[0].slice(4);
                    let message = msg.slice(nick.length + 6);
                    obj = {
                        type: 'discord',
                        nick: nick,
                        message: message
                    };
                } else if (msg.startsWith('[Server]') || msg.startsWith('Server:') || msg.startsWith('Nickname set to') || msg.startsWith('User: ')) {
                    obj = {
                        type: 'server',
                        message: msg
                    };
                } else if (msg.startsWith('-> ')) {
                    if (msg.startsWith('-> You tell ')) {
                        return msg;
                    }

                    let id = msg.slice(3).split(' ')[0];
                    let message = msg.slice(msg.indexOf(': ') + 2);
                    obj = {
                        type: 'dm',
                        from: id,
                        message: message
                    };
                } else if (msg.startsWith('(M) ')) {
                    let nick = msg.split(': ')[0].slice(4);
                    let message = msg.slice(nick.length + 6);
                    obj = {
                        type: 'moderator',
                        nick: nick,
                        message: message
                    };
                } else {
                    let sender = msg.split(': ')[0];
                    let message = msg.slice(sender.length + 2);

                    if (sender.match(/^[0-9]+$/)) {
                        obj = {
                            type: 'user',
                            id: sender,
                            message: message
                        };
                    } else {
                        let match = sender.match(/^\[([0-9]+)\] (.*)$/);

                        if (match === null) {
                            obj = {
                                type: 'admin',
                                nick: sender,
                                message: msg
                            };
                        } else {
                            obj = {
                                type: 'user',
                                id: match[1],
                                nick: match[2],
                                message: message
                            };
                        }
                    }
                }

                this.emit('message', obj);
                return msg;
            });

            OWOP.misc.chatSendModifier = msg => {
                if (!msg.startsWith('/')) return msg;
                let command = msg.slice(1).split(' ');

                if (command[0] === 'help') {
                    OWOP.chat.local('Local commands: ' + Object.keys(this.commands).join(', '));
                }

                if (!(command[0] in this.commands)) return msg;
                this.commands[command[0]](command.slice(1));
                return '';
            };
        }

        registerCommand(name, callback) {
            if (name in this.commands) throw 'Command is already registered';
            this.commands[name] = callback;
        }

        deregisterCommand(name) {
            delete this.commands[name];
        }

    }

    let chat = new Chat();

    chat.on('message', function(data) {
        if (data.type === 'user' && data.nick && players.list[data.id]) {
            players.list[data.id].nick = data.nick;
        }
    });

    _0x116e0b.players = players;
    _0x116e0b.chat = chat;
    _0x116e0b.Player = Player;
    console.log('core-utils loaded');
    
    exports.install = () => {}
    exports.uninstall = () => {
        alert("core-utils was uninstalled, please refresh for changes to take effect")
    }
    return exports
})();
